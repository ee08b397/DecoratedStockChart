!function(){angular.module("decorated-stock-chart",["ui.bootstrap"]).directive("decoratedStockChart",function($timeout){return{scope:{securities:"=",startDate:"@?",endDate:"@?",availableSecurityAttributes:"=",defaultSecurityAttribute:"=",onAttributeSelect:"&",onSecurityRemove:"&",title:"@",onDefaultAttributeChange:"&",highstockOptions:"=",apiHandle:"="},link:function(scope,elem){scope.id=_.uniqueId(),scope.states={securityAttrMap:[],chart:null,dateRange:{start:scope.startDate&&scope.endDate?new Date(scope.startDate==parseInt(scope.startDate)?parseInt(scope.startDate):scope.startDate):null,end:scope.startDate&&scope.endDate?new Date(scope.endDate==parseInt(scope.endDate)?parseInt(scope.endDate):scope.endDate):null}},elem.bind("contextmenu",function(){return!1}),scope.apiHandle.api={addSecurity:function(security){const isRedundant=-1!=_.chain(scope.states.securityAttrMap).map(function(securityAttrPair){return securityAttrPair[0].id}).uniq().value().indexOf(security.id);if(!isRedundant){const securityAttrPair=[security,[]];scope.states.securityAttrMap.push(securityAttrPair),scope.addAttr(scope.defaultSecurityAttribute,securityAttrPair)}},removeSecurity:function(id,supressCallback){const idx=_.findIndex(scope.states.securityAttrMap,function(securityAttrPair){return securityAttrPair[0].id==id});-1!=idx&&(scope.states.securityAttrMap.splice(idx,1),_.chain(scope.states.chart.series).filter(function(series){return series&&series.options.securityId==id}).each(function(series){series.remove()}),_.isFunction(scope.onSecurityRemove)&&!supressCallback&&scope.onSecurityRemove({id:id}))},changeDateRange:function(start,end){if(!start||!end||start>=end)return!0;const handle=this;scope.states.dateRange.start=start,scope.states.dateRange.end=end;const securityAttrMapCopy=angular.copy(scope.states.securityAttrMap);_.each(securityAttrMapCopy,function(pair){handle.removeSecurity(pair[0].id,!0),handle.addSecurity(pair[0])})}};const highstockOptions=_.extend({chart:{renderTo:"enriched-highstock-"+scope.id,type:"spline"},title:{text:scope.title||"Untitled",events:{click:dsc.onTitleClick}},plotOptions:{spline:{marker:{enabled:!1}}},xAxis:{type:"datetime"},yAxis:{title:{text:scope.defaultSecurityAttribute.label,events:{click:function(event){dsc.onAxisClick.call(this,event,scope)}}},id:"yAxis.1"},legend:{useHTML:!0},series:[],credits:{enabled:!1}},scope.highstockOptions);scope.seriesTransformer={toSimpleMA:function(origSeries,numDays){const sma=dsc.SMAFactory(numDays),xy=_.chain(origSeries.data).map(function(datum){return[datum.x,sma(datum.y)]}).value();return{id:origSeries.options.id+"."+numDays+"DaySMA",name:origSeries.name+" "+numDays+" Day SMA",data:xy,securityId:origSeries.options.securityId||null}},toExpMA:function(origSeries,numDays){return{id:origSeries.options.id+"."+numDays+"DayEMA",name:origSeries.name+" "+numDays+" Day EMA",data:origSeries.data.map(function(data){return[data.x,data.y*Math.random()]}),securityId:origSeries.options.securityId||null}},toBasis:function(series,otherSeries){const otherData=_.chain(otherSeries.data).map(function(datum){return[moment(datum.x).format("YYYYMMDD"),datum.y]}).object().value(),data=_.chain(series.data).filter(function(datum){return otherData[moment(datum.x).format("YYYYMMDD")]}).map(function(datum){return[datum.x,datum.y-otherData[moment(datum.x).format("YYYYMMDD")]]}).value();return{id:series.options.id+".basisVs."+otherSeries.options.id,name:"Basis of "+series.name+" - "+otherSeries.name,securityId:series.options.securityId||null,data:data}}},scope.addAttr=function($item,securityAttrPair){function processSeries(series){series.securityId=securityAttrPair[0].id,series.id=dsc.generateSeriesID(securityAttrPair[0],$item),series.onRemove=function(){scope.removeAttr($item,securityAttrPair)},scope.addSeries(series),scope.isProcessing=!1}securityAttrPair[1].push($item),scope.isProcessing=!0;const result=scope.onAttributeSelect({attr:$item,security:securityAttrPair[0],options:{dateRange:scope.states.dateRange}});result&&angular.isFunction(result.then)?result.then(function(series){processSeries(series)},function(){scope.isProcessing=!1}):processSeries(result)},scope.removeAttr=function(attr,securityAttrPair){const series=scope.states.chart.get(dsc.generateSeriesID(securityAttrPair[0],attr));series&&series.remove(),securityAttrPair[1].splice(securityAttrPair[1].indexOf(attr),1)},scope.$ctxMenu=dsc.buildContextMenuContainer(elem),scope.addSeries=function(seriesOption){const chart=scope.states.chart;chart.get(seriesOption.id)||(chart.addSeries(seriesOption),dsc.attachLegendEventHandlers(chart.get(seriesOption.id),scope))},scope.removeSeries=function(s){s.options.onRemove?s.options.onRemove():s.remove()},scope.toggleSlide=function(show,className){var $ctrl=elem.find("."+className);show?($ctrl.slideDown(500),$ctrl.find("input").first().select()):$ctrl.slideUp(500)},scope.changeDate=function(){return!scope.states.startDate||!scope.states.endDate||scope.states.startDate>=scope.states.endDate?!0:(scope.states.chart.xAxis[0].update(setDefinedDateRange(scope.states.startDate,scope.states.endDate).xAxis),!1)},$timeout(function(){scope.states.chart=new Highcharts.Chart(highstockOptions),_.each(scope.securities,function(security){scope.apiHandle.api.addSecurity(security)})})},templateUrl:"DecoratedStockChart.html"}})}(),function(){const root=this,dsc=root.dsc||{};root.dsc=dsc,root.dsc.attachLegendEventHandlers=function(series,scope){$(series.legendItem.element).css({"user-select":"none"}).mousedown(function(event){return 2==event.button?(event.preventDefault(),event.stopPropagation(),dsc.triggerSeriesContextMenu(event,{series:series,scope:scope})):void 0})},root.dsc.onAxisClick=function(event,scope){function removeAxis(){return $("<li><a><i class='fa fa-remove'></i>&nbsp;Remove Axis</a></li>").click(function(){for(;axis.series.length>0;)dsc.moveAxis(axis.series[0],0,scope);axis.remove()})}function editAxisTitle(){const $input=$("<input type='text' class='form-control' style='position:relative; left: 10%; width: 80%;'/>");$input.val(axis.axisTitle.textStr),$input.on("keydown",function(keyEvent){13==keyEvent.keyCode&&""!=$input.val()&&(keyEvent.preventDefault(),keyEvent.stopPropagation(),axis.setTitle({text:$input.val()}),$ctxMenu.hide())});const $menuItem=$("<li><span></span></li>").click(dsc.inertClickHandler);return $menuItem.children("span").append($input),$menuItem}event.preventDefault(),event.stopPropagation();const axis=this,$ctxMenu=scope.$ctxMenu;$ctxMenu.find(".dropdown-menu li").remove(),$ctxMenu.children(".dropdown-menu").append(editAxisTitle()),scope.states.chart.yAxis.length>1&&axis.userOptions.id!=scope.states.chart.yAxis[0].userOptions.id&&$ctxMenu.children(".dropdown-menu").append(removeAxis()),$ctxMenu.css({top:event.clientY+"px",left:event.clientX+"px"}),$ctxMenu.show(),$ctxMenu.find("input.form-control").select()},root.dsc.inertClickHandler=function(e){e.preventDefault(),e.stopPropagation()},root.dsc.moveAxis=function(series,axis,scope){const seriesOptions=series.options;"number"==typeof axis?seriesOptions.yAxis=axis:seriesOptions.yAxis=_.findIndex(scope.states.chart.yAxis,function(x){return x.userOptions.id==axis.userOptions.id}),seriesOptions.color=series.color,series.remove(),scope.addSeries(seriesOptions)},root.dsc.generateSeriesID=function(security,attr){return["Security",security.id,attr.tag].join(".")},root.dsc.onTitleClick=function(clickEvent){const chart=this,$container=$(this.container);if(0==$container.find("input.form-control").length){const $input=$("<input class='form-control floating-input' placeholder='Type a New Title, Hit Enter to Confirm, ESC to Cancel'/>");$input.on("keydown",function(keyEvent){13==keyEvent.keyCode&&""!=$input.val()?(chart.setTitle({text:$input.val()}),$input.remove()):27==keyEvent.keyCode&&$input.remove()}).css({top:$(clickEvent.target).position().top,left:"1%",width:"98%"}).appendTo($container),$input.focus()}},root.dsc.SMAFactory=function(period){var nums=[];return function(num){nums.push(num),nums.length>period&&nums.splice(0,1);var sum=0;for(var i in nums)sum+=nums[i];var n=period;return nums.length<period&&(n=nums.length),sum/n}}}(),function(){const root=this,dsc=root.dsc||{};root.dsc=dsc,root.dsc.buildContextMenuContainer=function(elem){const $ctxMenu=$("<div style='position: fixed; z-index: 10;'><ul class='clickable dropdown-menu multi-level' style='display: block;'></ul></div>").hide();return $ctxMenu.prependTo(elem),elem.click(function(){$ctxMenu.hide()}),$ctxMenu},root.dsc.triggerSeriesContextMenu=function(event,args){const $ctxMenu=args.scope.$ctxMenu;return $ctxMenu.find(".dropdown-menu li").remove(),_.each(dsc.buildMenuItems(args),function(menuItem){$ctxMenu.children(".dropdown-menu").append(menuItem)}),$ctxMenu.css({top:event.clientY+"px",left:event.clientX+"px"}),$ctxMenu.show(),!1},root.dsc.buildMenuItems=function(args){function transformerMenuItemGenerator(transformFn,text){const $input=$("<input type='text' placeholder='Day(s)' class='form-control' style='position: relative; width: 80%; left: 10%;'/>");return $("<li class='dropdown-submenu'><a>"+text+"</a></li>").click(function(e){e.preventDefault(),e.stopPropagation(),$input.focus()}).append($("<li class='dropdown-menu'><span></span></li>").click(dsc.inertClickHandler).append($input.on("keydown",function(keyEvent){if(13==keyEvent.keyCode){if(isNaN(parseInt($input.val()))||""==$input.val())return;const transformedSeries=transformFn(series,parseInt($input.val()));transformedSeries.disableFurtherTransformation=!0,scope.addSeries(transformedSeries),scope.$ctxMenu.hide()}})))}function changeType(){const $subMenu=$("<ul class='dropdown-menu'></ul>");return _.chain([["Line","spline","line-chart"],["Area","areaspline","area-chart"],["Column","column","bar-chart"]]).filter(function(type){return type[1]!==series.type}).each(function(type){$("<li><a><i class='fa fa-"+type[2]+"'></i>&nbsp;"+type[0]+"</a></li>").click(function(){series.update({type:type[1]}),dsc.attachLegendEventHandlers(series,scope)}).appendTo($subMenu)}),$("<li class='dropdown-submenu'><a>Change Chart Type</a></li>").append($subMenu)}const scope=args.scope,seriesTransformer=scope.seriesTransformer,series=args.series,disableTransformation=series.options.disableFurtherTransformation,chart=scope.states.chart,addMA=transformerMenuItemGenerator.bind(null,seriesTransformer.toSimpleMA,"Add Simple MA"),addMV=transformerMenuItemGenerator.bind(null,seriesTransformer.toExpMA,"Adding Exp MA"),basis=function(){return $("<li class='dropdown-submenu'><a>Show Basis vs. </a></li>").append(dsc.buildSeriesSubMenu({scope:scope,onClick:function(event,otherSeries){const transformedSeries=seriesTransformer.toBasis(series,otherSeries);scope.addSeries(transformedSeries)},currentSeries:series}))},removeSeries=function(){return $("<li><a>Remove</a></li>").click(function(){scope.$apply(function(){scope.removeSeries(series)})})},changeAxis=function(){return $("<li class='dropdown-submenu'><a>Change Axis</a></li>").append(dsc.buildAxesSubMenu(series,chart,scope))};return disableTransformation?[changeAxis(),basis(),changeType(),removeSeries()]:[changeAxis(),addMA(),addMV(),basis(),changeType(),removeSeries()]},root.dsc.buildSeriesSubMenu=function(args){const chart=args.scope.states.chart,callback=args.onClick,currentSeries=args.currentSeries,$subMenu=$("<ul class='dropdown-menu'></ul>"),filteredSeries=_.filter(chart.series,function(series){return currentSeries&&series.options.id!==currentSeries.options.id});return 0==filteredSeries.length?$subMenu.append("<li><a>No Other Series to Compare To</a></li>"):_.each(filteredSeries,function(series){$("<li><a>"+series.name+"</a></li>").click(function(event){callback(event,series)}).appendTo($subMenu)}),$subMenu},root.dsc.buildAxesSubMenu=function(series,chart,scope){const $dropdown=$("<ul class='dropdown-menu'></ul>");_.chain(chart.yAxis).filter(function(axis){return axis.userOptions.id!==series.yAxis.userOptions.id}).each(function(axis){const $menuItem=$("<li><a>Y-Axis: "+axis.options.title.text+"</a></li>").click(function(){dsc.moveAxis(series,axis,scope)});$dropdown.append($menuItem)});const axisId="yAxis."+(chart.yAxis.length+1);return $dropdown.append($('<li><a><i class="fa fa-plus"></i> Move To New Axis</a></li>').click(function(){chart.addAxis({title:{text:series.name,events:{click:function(event){dsc.onAxisClick.call(this,event,scope)}}},opposite:chart.axes.length%2==0,id:axisId}),dsc.moveAxis(series,chart.get(axisId),scope)})),$dropdown}}(),angular.module("decorated-stock-chart").run(["$templateCache",function($templateCache){$templateCache.put("DecoratedStockChart.html",'<div class="root" style="position: relative">\r\n    <i ng-show="isProcessing" style="position: absolute; left: 50%; z-index: 5" class="fa fa-spinner fa-spin fa-3x"></i>\r\n\r\n    <div class="control flex-container"\r\n         ng-init="showSecurityControl = false; showIndicatorControl = false; showBenchmarkControl = false;">\r\n        <!-- security & attributes selection -->\r\n            <span class="wrappable-flex-item">\r\n                <input type="text" ng-model="defaultSecurityAttribute" class="form-control"\r\n                       style="width: 8em; display: inline;"\r\n                       typeahead="attr as attr.label for attr in availableSecurityAttributes | filter:$viewValue | limitTo:8"/>\r\n            <a><i ng-click="toggleSlide(!showSecurityControl, \'security-control\'); showSecurityControl = !showSecurityControl"\r\n                  class="fa clickable"\r\n                  ng-class="{\'fa-chevron-up\': showSecurityControl, \'fa-chevron-down\': !showSecurityControl}"></i></a>\r\n        </span>\r\n        <!-- TODO implement these date functionalities -->\r\n        <span class="wrappable-flex-item">\r\n            <a class="clickable">1M</a>\r\n            &nbsp;\r\n            <a class="clickable">3M</a>\r\n            &nbsp;\r\n            <a class="clickable">6M</a>\r\n            &nbsp;\r\n            <a class="clickable">1Y</a>\r\n            &nbsp;\r\n            <a class="clickable">2Y</a>\r\n            &nbsp;\r\n            <span ng-init="showDateControl = false">\r\n                <a class="clickable"\r\n                   ng-click="toggleSlide(!showDateControl, \'date-control\');\r\n                             showDateControl = !showDateControl;\r\n                             dateChangeError = false;\r\n                             startDate = states.dateRange.start;\r\n                             endDate = states.dateRange.end">\r\n                    <i class="fa fa-calendar"></i>\r\n                </a>\r\n                <div class="date-control floating-form" style="display: none;">\r\n                    <label>From&nbsp;<input type="date" class="form-control"\r\n                                            style="display: inline; width: 12em;" ng-model="startDate"/></label>\r\n                    <label>To&nbsp;<input type="date" class="form-control"\r\n                                          style="display: inline; width: 12em;" ng-model="endDate"/></label>\r\n                    <button class="btn btn-success" ng-click="dateChangeError = apiHandle.api.changeDateRange(startDate, endDate)">\r\n                        <i class="fa fa-play"></i>\r\n                    </button>\r\n                    <p ng-show="dateChangeError">Invalid date range.  Please check and try again.</p>\r\n                </div>\r\n            </span>\r\n        </span>\r\n        <span class="wrappable-flex-item">\r\n            <span class="flex-container">\r\n                <span class="menu-container">\r\n                    <a class="clickable"\r\n                       ng-click="toggleSlide(!showIndicatorControl,\'indicator-control\'); showIndicatorControl = !showIndicatorControl">\r\n                        <i class="fa fa-plus"></i>&nbsp;Macro Indicator &amp; Market Index\r\n                    </a>\r\n                    <div class="indicator-control floating-form" style="display: none; left: -100%">\r\n                        <label>\r\n                            Search&nbsp;\r\n                            <input type="text" placeholder="ex: S&P 500, Financial CDS ..." class="form-control"\r\n                                   style="width: 26em;"/>\r\n                            <!-- TODO implement searching for macro indicators etc through callback -->\r\n                        </label>\r\n                    </div>\r\n                </span>\r\n                <span> &nbsp; </span>\r\n                <span class="menu-container">\r\n                    <a class="clickable"\r\n                       ng-click="toggleSlide(!showBenchmarkControl, \'benchmark-control\'); showBenchmarkControl = !showBenchmarkControl">\r\n                        <i class="fa fa-plus"></i>&nbsp;Custom Benchmark\r\n                    </a>\r\n                    <div class="benchmark-control floating-form" style="display: none; left: -100%;">\r\n                        <!-- TODO implement constructing custom benchmark time series -->\r\n                        <label>\r\n                            Sector&nbsp;\r\n                            <input type="text" class="form-control"/>\r\n                        </label>\r\n                        <label>\r\n                            Rating&nbsp;\r\n                            <input type="text" class="form-control"/>\r\n                        </label>\r\n                        <label>\r\n                            WAL&nbsp;\r\n                            <input type="text" class="form-control"/>\r\n                        </label>\r\n                        <label>\r\n                            Analytic&nbsp;\r\n                            <input type="text" class="form-control"/>\r\n                        </label>\r\n                        <button class="btn btn-success"><i class="fa fa-play"></i></button>\r\n                    </div>\r\n                </span>\r\n            </span>\r\n        </span>\r\n    </div>\r\n    <div class="security-control floating-form" style="display: none;">\r\n        <div ng-show="states.securityAttrMap.length === 0">\r\n            <h5>No Security Selected</h5>\r\n        </div>\r\n        <div class="flex-container">\r\n            <div class="wrappable-flex-item" ng-repeat="securityAttrPair in states.securityAttrMap">\r\n                <!-- selected attributes display -->\r\n                    <span class="label label-success">{{securityAttrPair[0].label}} | <i class="fa fa-remove clickable"\r\n                                                                                         ng-click="apiHandle.api.removeSecurity(securityAttrPair[0].id)"></i></span>\r\n                    <span class="label label-primary" ng-repeat="attr in securityAttrPair[1]">\r\n                            {{attr.label}} | <i class="fa fa-remove clickable"\r\n                                                ng-click="removeAttr(attr, securityAttrPair)"></i>\r\n                    </span>\r\n                <!-- input to select more attributes-->\r\n                &nbsp;\r\n                <input type="text"\r\n                       placeholder="+ Attribute"\r\n                       ng-disabled="securityAttrPair[1].length >= 2"\r\n                       ng-model="selected"\r\n                       typeahead="attr.label for attr in availableSecurityAttributes | filter:$viewValue | limitTo:8"\r\n                       class="form-control"\r\n                       style="width: 8em; display: inline;"\r\n                       typeahead-on-select="addAttr($item, securityAttrPair); selected = \'\'">\r\n\r\n            </div>\r\n        </div>\r\n    </div>\r\n    <hr/>\r\n    <div ng-attr-id="{{\'enriched-highstock-\'+id}}" class="row">\r\n        <!-- this is where the stock chart goes -->\r\n    </div>\r\n</div>\r\n')}]);